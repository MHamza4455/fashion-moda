<!-- /sections/section-customer-favourites-video-carousel.liquid -->
{%- liquid
  assign unique = section.id
  assign section_width = section.settings.width
  assign heading_size = section.settings.heading_size | times: 0.01
  assign text_size = section.settings.text_size | times: 0.01
  assign animations_enabled = settings.animations_enabled
  assign animation_anchor = '#CustomerFavouritesVideoCarousel--' | append: unique
  assign animation_delay = 150
-%}

{%- style -%}
  #CustomerFavouritesVideoCarousel--{{ unique }} {
    --PT: {{ section.settings.padding_top }}px;
    --PB: {{ section.settings.padding_bottom }}px;
    --adjust-heading: calc(var(--FONT-ADJUST-HEADING) * {{ heading_size }});
  }
  #CustomerFavouritesVideoCarousel--{{ unique }} .section__subheading { --adjust-body: calc(var(--FONT-ADJUST-SUBHEADING) * {{ text_size }}); }

  @media (max-width: 768px) {
    .customer-favourites-video-carousel.section-padding {
        padding-top: calc(var(--PT) * .5);
        padding-bottom: calc(var(--PB) * .7);
    }
  }
{%- endstyle -%}

<link href="{{ 'customer-favourites-video-carousel.css' | asset_url }}" rel="stylesheet" type="text/css">

<div id="CustomerFavouritesVideoCarousel--{{ unique }}"
  class="section-padding customer-favourites-video-carousel"
  data-section-id="{{ unique }}"
  data-section-type="customer-favourites-video-carousel">
  <div class="{{ section_width }}">

    {%- if section.settings.subheading != blank -%}
      <div class="section__subheading {{ section.settings.align_text }}"
        data-aos="fade-up"
        data-aos-anchor="{{ animation_anchor }}"
        data-aos-delay="{{ animation_delay }}"
        {%- assign animation_delay = animation_delay | plus: 150 -%}>
        {{ section.settings.subheading }}
      </div>
    {%- endif -%}

    {%- if section.settings.title != '' -%}
      <div class="section__header {{ section.settings.align_text }}">
        <h2 class="section__heading h2"
          data-aos="fade-up"
          data-aos-anchor="{{ animation_anchor }}"
          data-aos-delay="{{ animation_delay }}"
          {%- assign animation_delay = animation_delay | plus: 150 -%}>{{ section.settings.title }}</h2>

        {%- if settings.show_spacer_lines -%}
          <hr class="section__heading-line"{% if animations_enabled %}
            data-aos="fade-up"
            data-aos-anchor="{{ animation_anchor }}"
            data-aos-delay="{{ animation_delay }}"
            {%- assign animation_delay = animation_delay | plus: 150 -%}
          {% endif %}>
        {%- endif -%}
      </div>
    {%- endif -%}

    <!-- Video carousel content -->
    {%- if section.blocks.size > 0 -%}
      <div class="customer-favourites-video-carousel__content">
        <div class="video-carousel__slider" data-slider>
          {%- for block in section.blocks -%}
            {% case block.type %}
            {% when 'slide' %}
            {%- liquid
              assign video_file = block.settings.video_file
              assign selected_product = block.settings.product_variant
              assign selected_variant_id = block.settings.variant_id
              assign unique_id = block.id

              if selected_product != blank
                assign product = selected_product
                assign variant = product.first_available_variant

                if selected_variant_id != blank and selected_variant_id != ""
                  assign selected_variant_id_num = selected_variant_id | plus: 0
                  assign variant_found = false
                  for product_variant in product.variants
                    if product_variant.id == selected_variant_id_num
                      assign variant = product_variant
                      assign variant_found = true
                      break
                    endif
                  endfor
                  
                  comment
                    If the specified variant ID was not found, check for default variant metafield
                  endcomment
                  if variant_found == false
                    assign default_variant_id = product.metafields.custom.default_variant
                    if default_variant_id != blank
                      assign default_variant_id_num = default_variant_id | plus: 0
                      for product_variant in product.variants
                        if product_variant.id == default_variant_id_num
                          assign variant = product_variant
                          break
                        endif
                      endfor
                    endif
                  endif
                else
                  comment
                    No variant ID specified, check for default variant metafield
                  endcomment
                  assign default_variant_id = product.metafields.custom.default_variant
                  if default_variant_id != blank
                    assign default_variant_id_num = default_variant_id | plus: 0
                    for product_variant in product.variants
                      if product_variant.id == default_variant_id_num
                        assign variant = product_variant
                        break
                      endif
                    endfor
                  endif
                endif

                assign product_title = product.title
                assign variant_description = variant.title
                assign product_price = variant.price
                assign product_compare_price = variant.compare_at_price
                assign product_image = variant.featured_image | default: product.featured_image
                assign product_url = product.url
                if variant.id
                  assign product_url = product_url | append: '?variant=' | append: variant.id
                endif
              endif
            -%}

            <div class="video-slide carousel__item" {{ block.shopify_attributes }} data-slider-item>
              {%- if product != blank -%}
                <a href="{{ product_url }}" class="video-slide__product-link">
              {%- endif -%}

                <!-- Video Section -->
                {%- if video_file != blank -%}
                  <div class="video-slide__video-wrapper video-wrapper">
                    <video
                      class="video-slide__video"
                      id="slide-{{ unique_id }}-video"
                      playsinline
                      loop
                      muted
                      preload="metadata">
                      {%- if video_file.sources[1].url -%}
                        <source src="{{ video_file.sources[1].url }}" type="video/mp4">
                      {%- endif -%}
                      Your browser does not support the video tag.
                    </video>

                    {%- render 'video-controls',
                      show_video_flow_controls: true,
                      show_video_sound_controls: true,
                      use_new_video_icons: true
                    -%}
                  </div>
                {%- endif -%}

                <!-- Product Section -->
                {%- if product != blank -%}
                  <div class="video-slide__product">
                    {%- if product_image -%}
                      <div class="video-slide__product-image">
                        <img src="{{ product_image | img_url: '150x150' }}"
                             alt="{{ product_image.alt | default: product_title }}"
                             loading="lazy">
                      </div>
                    {%- endif -%}

                   <div class="video-slide__product-details">
                      <div>
                        <h4 class="video-slide__product-title">{{ product_title }}</h4>
                         <div class="video-slide__product-benefit">{{ product.metafields.custom.key_benefits | metafield_tag }}</div>
                        </div>
                        <div class= "video-slide__product-info">
                            <div class="video-slide__product-pricing">
                                {%- if product_compare_price and product_compare_price > product_price -%}
                                    <span class="video-slide__price-compare">{{ product_compare_price | money }}</span>
                                    <span class="video-slide__price-sale">{{ product_price | money }}</span>
                                {%- else -%}
                                    <span class="video-slide__price">{{ product_price | money }}</span>
                                {%- endif -%}
                            </div>
                        </div>
                    </div>
                  </div>
                {%- endif -%}

              {%- if product != blank -%}
                </a>
              {%- endif -%}
            </div>
            {% endcase %}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

  </div>
</div>

{% schema %}
  {
    "name": "Portrait Video Carousel",
    "class": "index-section",
    "settings": [
      {
        "type": "text",
        "id": "title",
        "label": "Heading"
      },
      {
        "type": "text",
        "id": "subheading",
        "label": "Subheading"
      },
      {
        "type": "header",
        "content": "Layout"
      },
      {
        "type": "select",
        "id": "align_text",
        "label": "Heading alignment",
        "default": "text-left",
        "options": [
          { "value": "text-left", "label": "Left" },
          { "value": "text-center", "label": "Centered" }
        ]
      },
      {
        "type": "header",
        "content": "Text"
      },
      {
        "type": "range",
        "id": "heading_size",
        "label": "Heading size",
        "default": 120,
        "min": 70,
        "max": 200,
        "step": 10,
        "unit": "%"
      },
      {
        "type": "range",
        "id": "text_size",
        "label": "Text size",
        "default": 100,
        "min": 70,
        "max": 150,
        "step": 10,
        "unit": "%"
      },
      {
        "type": "header",
        "content": "Section spacing"
      },
      {
        "type": "select",
        "id": "width",
        "label": "Width",
        "default": "wrapper",
        "options": [
          { "value": "wrapper--full-padded", "label": "Full width padded" },
          { "value": "wrapper", "label": "Page width" }
        ]
      },
      {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding top",
        "default": 80
      },
      {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding bottom",
        "default": 100
      }
    ],
    "blocks": [
      {
        "type": "slide",
        "name": "Video Slide",
        "settings": [
          {
            "type": "header",
            "content": "Video"
          },
          {
            "type": "video",
            "id": "video_file",
            "label": "Video file",
            "info": "Upload video file (used for both desktop and mobile)"
          },
          {
            "type": "header",
            "content": "Product"
          },
          {
            "type": "product",
            "id": "product_variant",
            "label": "Select Product"
          },
          {
            "type": "text",
            "id": "variant_id",
            "label": "Variant ID",
            "info": "Enter the variant ID for the specific variant you want to display (optional - will use first variant if empty)"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Portrait Video Carousel",
        "category": "Video",
        "blocks": [
          {
            "type": "slide"
          },
          {
            "type": "slide"
          },
          {
            "type": "slide"
          }
        ]
      }
    ],
    "disabled_on": {
      "groups": ["header", "aside", "footer"]
    }
  }
{% endschema %} 
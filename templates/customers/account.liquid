<!-- /templates/customers/account.liquid -->
<section class="page-customer" data-customer-account>
  <div class="wrapper">
    <div class="account-wrapper">
      <div class="account text-left">
        <div class="section__header">
          <h1 class="section__heading account__heading">{{ 'customer.account.title' | t }}</h1>
          <a class="account__logout" href="{{ routes.account_logout_url }}">{{ 'layout.customer.log_out' | t }}</a>

          {%- if settings.show_spacer_lines -%}
            <hr class="section__heading-line">
          {%- endif -%}
        </div>

        <div class="account__table">
          <div class="account__table__item">
            <h4 class="account__heading">{{ 'customer.orders.title' | t }}</h4>
            {% comment %}
            If we have past orders, loop through each one
            {% endcomment %}
            {% paginate customer.orders by 20 %}
              {% if customer.orders.size != 0 %}
                <div class="table-wrap">
                  <table class="full">
                    <thead class="desktop-order">
                      <tr>
                        <th>{{ 'customer.orders.order_number' | t }}</th>
                        <th>{{ 'customer.orders.date' | t }}</th>
                        <th>{{ 'customer.orders.payment_status' | t }}</th>
                        <th>{{ 'customer.orders.fulfillment_status' | t }}</th>
                        <th>{{ 'customer.orders.total' | t }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for order in customer.orders %}
                        {%- liquid
                          if order.total_price == 0
                            assign order_total = 'products.product.free' | t | link_to: order.customer_url
                          else
                            assign order_total = order.total_price | money_with_currency | link_to: order.customer_url
                          endif
                        -%}

                        <tr class="responsive-order">
                          <th class="order-title">{{ 'customer.orders.order_number' | t }}</th>
                          <td class="order-title">{{ order.name | link_to: order.customer_url }}</td>
                          <th>{{ 'customer.orders.date' | t | link_to: order.customer_url }}</th>
                          <td>{{ order.created_at | date: format: 'month_day_year' | link_to: order.customer_url }}</td>
                          <th>{{ 'customer.orders.payment_status' | t | link_to: order.customer_url }}</th>
                          <td>{{ order.financial_status_label | link_to: order.customer_url }}</td>
                          <th>{{ 'customer.orders.fulfillment_status' | t | link_to: order.customer_url }}</th>
                          <td>{{ order.fulfillment_status_label | link_to: order.customer_url }}</td>
                          <th>{{ 'customer.orders.total' | t | link_to: order.customer_url }}</th>
                          <td>{{- order_total -}}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p>{{ 'customer.orders.none' | t }}</p>
              {% endif %}

              {% if paginate.pages > 1 %}
                {%- if settings.show_spacer_lines -%}
                  <hr class="hr--full">
                {%- endif -%}
                <div class="pagination">
                  {{ paginate | default_pagination | replace: '&laquo; Previous', '&larr;' | replace: 'Next &raquo;', '&rarr;' }}
                </div>
              {% endif %}
            {% endpaginate %}
            {% if settings.loyalty_enabled %}
              {% if settings.loyalty_explict_opt_in %}  
                <div class="loyaltysection" style="display:none">
                  <br /><br />
                  <h4>{{ 'customer.register.my_account_loyalty_title' | t }}</h4>
                  <p>{{ 'customer.register.my_account_loyalty_content' | t }}</p>
                  <a href="javascript:void(0)" onclick="CreateCustomer()" class="btn btn--solid btn--small btn--black">{{ 'customer.register.my_account_signup_button_title' | t }}</a>
                  <p style="font-size: 13px;">{{ 'customer.register.my_account_loyalty_marketing_text_html' | t }}</p>
                </div>
                <div class="yotpo-widget-data" style="display:none">
                  <br /><br />
                  <h4>{{ 'customer.register.my_account_loyalty_title' | t }}</h4>
                  <div class="yotpo-widget-instance" data-yotpo-instance-id="{{ settings.widget_instance_id1 }}"></div>
                  <div class="yotpo-widget-instance" data-yotpo-instance-id="{{ settings.widget_instance_id2 }}"></div>
                </div>
              {% else %}
                <div class="yotpo-widget-data">
                  <br /><br />
                  <h4>{{ 'customer.register.my_account_loyalty_title' | t }}</h4>
                  <div class="yotpo-widget-instance" data-yotpo-instance-id="{{ settings.widget_instance_id1 }}"></div>
                  <div class="yotpo-widget-instance" data-yotpo-instance-id="{{ settings.widget_instance_id2 }}"></div>
                </div>
              {% endif %}
            {% endif %}
          </div>
          <div class="account__table__item">
              <h4>{{ 'customer.account.details' | t }}</h4>

              {% if customer.default_address != nil %}
                <p>{{ customer.default_address.first_name }} {{ customer.default_address.last_name }}<br>
                  {{ customer.default_address.address1 }}<br>
                  {% if customer.default_address.address2 != "" %}
                    {{ customer.default_address.address2 }}<br>
                  {% endif %}
                  {% if customer.default_address.city != "" %}
                    {{ customer.default_address.city }}<br>
                  {% endif %}
                  {% if customer.default_address.province_code != nil %}
                    {{ customer.default_address.province_code | upcase }}<br>
                  {% endif %}
                  {% if customer.default_address.zip != "" %}
                    {{ customer.default_address.zip | upcase }}<br>
                  {% endif %}
                  {% if customer.default_address.country != "" %}
                    {{ customer.default_address.country }}<br>
                  {% endif %}
                  {% if customer.default_address.phone != "" %}
                    {{ customer.default_address.phone }}
                  {% endif %}
                </p>
              {% else %}
                <p>{{ customer.name }}</p>
              {% endif %}
              <p><a href="{{ routes.account_addresses_url }}">{{ 'customer.account.view_addresses' | t }} ({{ customer.addresses_count }})</a></p>
              {%- if settings.site_brand == 'ren' -%}
                <!-- Begin Recharge code -->
                <p><a href="/tools/recurring/login/">Manage Subscriptions</a></p>
                <!-- End Recharge code -->
              {% endif %}
              {%- if settings.site_brand == 'livingproof' and settings.site_region == 'us' -%}
                <!-- Begin Ordergroove code -->
                <p><a href="/apps/subscriptions/manage">Manage Subscriptions</a></p>
                <!-- End Ordergroove code -->
              {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if settings.loyalty_enabled and settings.loyalty_explict_opt_in %}
<script>

( async() => {
    
 let storeDo = Shopify.shop || "default-shop-name"; // Ensure a fallback if Shopify.shop is undefined

if (!storeDo) {
  console.error("Shopify.shop is not available");
} else {
  const formdata = new FormData();
  formdata.append("email", "{{ customer.email }}");
  formdata.append("storeDo", storeDo);

  const requestOptions = {
    method: "POST",
    body: formdata,
    redirect: "follow"
  };

  try {
    const getCustomer = await fetch("{{settings.app_loyalty_fetch_customer_url}}", requestOptions);
    if (getCustomer.status === 200) {
      const { customer } = await getCustomer.json();
      if (!customer.opt_in) {
        document.getElementsByClassName('loyaltysection')[0].style.display = "block";
      } else {
        document.getElementsByClassName('yotpo-widget-data')[0].style.display = "block";
      }
    } else {
      console.error("Failed to fetch customer data", getCustomer.status);
    }
  } catch (error) {
    console.error("Error in fetching customer data", error);
  }
}

})();

    async function CreateCustomer () {
    let FirstName = "{{ customer.first_name }}";
    let LastName = "{{ customer.last_name }}";
    let Email = "{{ customer.email }}";
    let LoyaltyProgram = true;
    let storeDo = Shopify.shop || "default-shop-name"; // Ensure a fallback

     var formdata = new FormData();
    formdata.append("email", Email);
    formdata.append("firstName", FirstName);
    formdata.append("lastName", LastName);
    formdata.append("loyalty_program", LoyaltyProgram);
    formdata.append("storeDo", storeDo);

      const requestOptions = {
        method: "POST",
        body: formdata,
        redirect: "follow"
      };

      try {
        await fetch("{{settings.app_loyalty_url}}", requestOptions);
        setTimeout(() => {
          location.reload(true);
        }, 2000);
      } catch (error) {
        console.error("Error in creating customer", error);
      }
      }

</script>
{% endif %}

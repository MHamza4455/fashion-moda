{%- liquid
  assign heading = block_settings.accordion_heading
  assign text = block_settings.accordion_text
  assign page = block_settings.accordion_page
  assign content = page.content | default: text
  assign heading_style = block_settings.heading_style
  assign open_in_side_tray = block_settings.open_in_side_tray
  assign retain_aspect = block_settings.retain_video_aspect_ratio
-%}

{%- if heading != '' and content != '' -%}
  {% if open_in_side_tray %}
    <div>
      <button type="button" class="open-side-tray-btn" data-tray-id="accordion-{{ block_id }}">
        {{ heading | strip_html | escape }}
        {%- render 'icon-toggle-plus-lp' -%}
        {%- render 'icon-toggle-minus-lp' -%}
      </button>
      <div id="side-tray-accordion-{{ block_id }}" class="side-tray">
        <div class="side-tray-header">
          <span class="side-tray-title">{{ heading }}</span>
          <button type="button" class="close-side-tray-btn" data-tray-id="accordion-{{ block_id }}" aria-label="Close">
            {%- render 'icon-close' -%}
          </button>
        </div>
        <div class="side-tray-content">
          {% assign heading_stripped = heading | strip_html | strip | downcase %}
          {% assign video_url = block_settings.video_url %}
          {% assign metafield_video = product.metafields.custom.how_to_use_video %}
          {% assign play_video_as_popup = block_settings.play_video_as_popup %}
          {% assign active_video = metafield_video %}
          {% if active_video == blank %}
            {% assign active_video = video_url %}
          {% endif %}
          {% if heading_stripped contains 'how to use' and active_video != blank %}
            {% if play_video_as_popup %}
              <div class="how-to-use-video-popup-wrapper mb-16" data-modal-id="how-to-use-video-modal-{{ block_id }}" style="position:relative;width:100%;max-width:100%;cursor:pointer;">
                <video class="how-to-use-video-thumb" style="width:100%;display:block;pointer-events:none;filter:brightness(0.7);" preload="metadata" poster="" tabindex="-1">
                  {% if metafield_video != blank %}
                    <source src="{{ metafield_video | file_url }}#t=0.1" type="video/mp4">
                  {% else %}
                    <source src="{{ video_url }}#t=0.1" type="video/mp4">
                  {% endif %}
                </video>
                <button class="how-to-use-video-play-btn" aria-label="Play video" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:none;border:none;padding:0;cursor:pointer;z-index:2;">
                  {%- render 'icon-play', class: 'icon-play-lg' -%}
                </button>
              </div>
            {% else %}
              {% if retain_aspect %}
                <div class="video-aspect-ratio" style="position:relative;width:100%;padding-top:56.25%;background:#000;">
                  <video controls{% if play_video_as_popup %} autoplay{% endif %} style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;" preload="metadata" playsinline muted>
                    <source src="{% if metafield_video != blank %}{{ metafield_video | file_url }}{% else %}{{ video_url }}{% endif %}#t=0.1" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                </div>
              {% else %}
                <video controls{% if play_video_as_popup %} autoplay{% endif %} style="width:100%;margin-bottom:16px;" preload="metadata" playsinline muted>
                  <source src="{% if metafield_video != blank %}{{ metafield_video | file_url }}{% else %}{{ video_url }}{% endif %}#t=0.1" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              {% endif %}
            {% endif %}
          {% endif %}
          {{ content }}
        </div>
      </div>
      <script src="{{ 'accordion-side-tray.js' | asset_url }}" defer></script>
    </div>
  {% else %}
    <div class="product__accordion">
      <button class="product__accordion__title {{ heading_style }}" aria-controls="ProductAccordion--page-{{ heading | handle }}--{{ section.id }}--{{ block_id }}" data-collapsible-trigger>
        {{- heading -}}
        {%- if settings.site_brand == 'livingproof' and settings.site_region == 'us' -%}
          {%- render 'icon-toggle-plus-lp' -%}
          {%- render 'icon-toggle-minus-lp' -%}
        {%- else -%}
          {%- render 'icon-toggle-plus' -%}
          {%- render 'icon-toggle-minus' -%}
        {%- endif -%}
      </button>
      <div class="product__accordion__content" id="ProductAccordion--page-{{ heading | handle }}--{{ section.id }}--{{ block_id }}" data-collapsible-container>
        <div class="product__accordion__inner rte" data-collapsible-content>
          {{- content -}}
        </div>
      </div>
    </div>
  {% endif %}
{%- endif -%}

{%- comment -%} Render the video modal at the end of the file, as a direct child of body {%- endcomment -%}
{% if heading_stripped contains 'how to use' and active_video != blank and play_video_as_popup %}
  <div id="how-to-use-video-modal-{{ block_id }}" class="how-to-use-video-modal" data-move-to-body style="display:none;position:fixed;z-index:110000;top:0;left:0;width:100vw;height:100vh;background:rgba(0, 0, 0, 0.6);align-items:center;justify-content:center;">
    <button class="how-to-use-video-modal-close" aria-label="Close video" style="position:absolute;top:24px;right:32px;font-size:2.5rem;color:black;background:white;border-radius:4px;padding:0 4px 6px;border:none;z-index:10;cursor:pointer;">&times;</button>
    <div class="how-to-use-video-modal-content" style="position:relative;width:90vw;max-width:700px;margin:auto;top:5vh;">
      {% if active_video contains 'youtube.com' or active_video contains 'youtu.be' %}
        <iframe width="100%" height="400" src="https://www.youtube.com/embed/{{ active_video | split: 'v=' | last | split: '&' | first }}?autoplay=1" frameborder="0" allowfullscreen></iframe>
      {% elsif active_video contains 'vimeo.com' %}
        <iframe src="https://player.vimeo.com/video/{{ active_video | split: '/' | last }}?autoplay=1" width="100%" height="400" frameborder="0" allowfullscreen></iframe>
      {% else %}
        {% if retain_aspect %}
          <div class="video-aspect-ratio" style="position:relative;width:100%;padding-top:56.25%;background:#000;">
            <video controls{% if play_video_as_popup %} autoplay{% endif %} style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;">
              <source src="{% if metafield_video != blank %}{{ metafield_video | file_url }}{% else %}{{ video_url }}{% endif %}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
        {% else %}
          <video controls{% if play_video_as_popup %} autoplay{% endif %} style="width:100%;max-height:70vh;">
            <source src="{% if metafield_video != blank %}{{ metafield_video | file_url }}{% else %}{{ video_url }}{% endif %}" type="video/mp4">
            Your browser does not support the video tag.
          </video>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endif %}
